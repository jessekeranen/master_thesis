---
title: "Portofolio returns"
author: "Jesse Ker√§nen"
date: "12/21/2023"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(ggplot2)
library(zoo)
library(writexl)
library(gridExtra)
library(tikzDevice)
library(forecast)
library(sandwich)

theme_set(theme_grey())

#theme_set(theme_classic() + 
#    theme(panel.grid.major = element_line(colour = "lightgrey", linewidth = 0.25),
#    panel.grid.minor = element_line(colour = "lightgrey", linewidth = 0.125)))
```

```{r}
load(file = "Data/data.Rdata")
independend_variables <- c("CA", "CTO", "BEME", "CFP", "INV", "DEBT", "SP", "EP",
                           "ROA", "ROE", "Q", "MOM7", "MOM12", "MOM36", "MOM2",
                           "MOM.IND", "L.SD", "L.HIGH52.RATIO", "L.BETA",
                           "L.IDVOL", "L.LOG.USD.MV", "L.TO", "L.OBV")
setorder(data, Date, Company)
```

```{r}
data2 <- copy(data[, .(Date, pf.size, year, Company, USD.RET, EXC.USD.RET,
                       L.USD.MV, FM.EXP.RET, RF.EXP.RET, NN.EXP.RET)])
setorder(data2)
quantiles <- seq(0.1, 0.9, by = 0.1)

factor <- function(dt, variable, name, labels, quantiles) {
  # browser()
  dt[, temp := cut(.SD[, get(variable)], 
                   breaks = c(-Inf, quantile(.SD[pf.size == "Big", get(variable)],
                        quantiles, na.rm = T), Inf), labels = labels), by = Date]
  temp2 <- dt[is.na(temp)]
  setnames(dt, "temp", name)
  return(dt)
}
data2 <- factor(data2[Date >= as.POSIXct("1994-7-31", tz = "UTC") &
                      Date < as.POSIXct("2022-12-30", tz = "UTC")],
                "FM.EXP.RET", "FM.POSITION", c("FM.Low", "FM.2", "FM.3", "FM.4",
                 "FM.5", "FM.6", "FM.7", "FM.8", "FM.9", "FM.High"), quantiles)
data2 <- factor(data2, "RF.EXP.RET", "RF.POSITION", c("RF.Low", "RF.2", "RF.3",
            "RF.4", "RF.5", "RF.6", "RF.7", "RF.8", "RF.9", "RF.High"), quantiles)
data2 <- factor(data2, "NN.EXP.RET", "NN.POSITION", c("NN.Low", "NN.2", "NN.3",
            "NN.4", "NN.5", "NN.6", "NN.7", "NN.8", "NN.9", "NN.High"), quantiles)

portfolioreturns <- function(dt, portfolio, return){
  #browser()
  portfolio_returns <- dt[, .(EW.RET = mean(EXC.USD.RET, na.rm = T), 
                      VW.RET = weighted.mean(EXC.USD.RET, L.USD.MV, na.rm = T),
                      EW.EXP.RET = mean(get(return), na.rm = T),
                      VW.EXP.RET = weighted.mean(get(return), L.USD.MV, na.rm = T)),
                      by = c("Date", portfolio)]
  portfolio_returns <- melt(portfolio_returns, id.vars = c("Date", portfolio))
  return(dcast(portfolio_returns, paste("... ~ ", portfolio), value.var = "value"))
}
portfolio_returns1 <- portfolioreturns(data2, "FM.POSITION", "FM.EXP.RET")
portfolio_returns2 <- portfolioreturns(data2, "RF.POSITION", "RF.EXP.RET")
portfolio_returns3 <- portfolioreturns(data2, "NN.POSITION", "NN.EXP.RET")
portfolio_returns <- merge(portfolio_returns1, portfolio_returns2,
                           by = c("Date", "variable"))
portfolio_returns <- merge(portfolio_returns, portfolio_returns3,
                           by = c("Date", "variable"))

portfolio_returns[, `:=` (RF = RF.High - RF.Low, FM = FM.High - FM.Low,
                          NN = NN.High - NN.Low), by = c("Date", "variable")]
portfolio_returns_long <- melt(portfolio_returns, id.vars = c("Date", "variable"),
                               variable.name = "Portfolio", value.name = "Return")
portfolio_returns_long <- portfolio_returns_long[, cum_prod := cumprod(Return + 1),
                                                 by = c("Portfolio", "variable")]
portfolio_returns_long[, `:=` (Method = substr(Portfolio, 1, 2),
                    Position = as.factor(substr(Portfolio, 4, length(Portfolio))))]

market_return <- data[Date >= min(portfolio_returns$Date), .(VW.RET = 
                      weighted.mean(USD.RET, L.USD.MV), RF = mean(RF)), by = Date]
setorder(market_return, Date)
market_return[, MKT.RET := VW.RET - RF][, cum_prod := cumprod(MKT.RET + 1)]

tikz(file = "Latex/R_graphs/cumul_vw_LS_return.tex", width = 6, height = 4)
plot1 <- ggplot() + geom_line(data = portfolio_returns_long[Portfolio %in% 
        c("FM", "RF", "NN") & variable == "VW.RET"], aes(x = Date, y = cum_prod, color = Method)) + scale_y_log10() + geom_line(data = market_return, aes(x = Date, y = cum_prod)) + theme(axis.title = element_blank(), legend.position = "bottom", text = element_text(size = 9))
print(plot1)
dev.off()

tikz(file = "Latex/R_graphs/cumul_ew_LS_return.tex", width = 6, height = 4)
plot2 <- ggplot() + geom_line(data = portfolio_returns_long[Portfolio %in% c("FM", "RF", "NN") & variable == "EW.RET"], aes(x = Date, y = cum_prod, color = Method)) +
  scale_y_log10() + geom_line(data = market_return, aes(x = Date, y = cum_prod)) +
  theme(axis.title = element_blank(), legend.position = "bottom", 
        text = element_text(size = 9))
print(plot2)
dev.off()

tikz(file = "Latex/R_graphs/cumul_vw_portf_return.tex", width = 6, height = 4)
plot3 <- ggplot() + geom_line(data = portfolio_returns_long[Position %in% c("Low", "High") & variable == "VW.RET"], aes(Date, cum_prod, color = Method, linetype = Position)) + scale_y_log10() + geom_line(data = market_return, aes(Date, cum_prod)) +
  theme(axis.title = element_blank(), legend.position = "bottom", text =
          element_text(size = 9))
print(plot3)
dev.off()

tikz(file = "Latex/R_graphs/cumul_ew_portf_return.tex", width = 6, height = 4)
plot4 <- ggplot() + geom_line(data = portfolio_returns_long[Position %in% c("Low", "High") & variable == "EW.RET"], aes(Date, cum_prod, color = Method, linetype = Position)) + scale_y_log10() + geom_line(data = market_return, aes(Date, cum_prod)) +
  theme(axis.title = element_blank(), legend.position = "bottom", text =
          element_text(size = 9))
print(plot4)
dev.off()
plot1
plot2
plot3
plot4
```

```{r}
exp_portfolio_returns_long <- portfolio_returns_long[variable %in% c("EW.EXP.RET",
                                                                     "VW.EXP.RET")]
exp_portfolio_returns_long <- exp_portfolio_returns_long[, .(EXP.RET = mean(Return)),
                                                    by = c("variable", "Portfolio")]
exp_portfolio_returns_long[, variable := gsub(".EXP", "", variable)]
portfolio_returns_long2 <- portfolio_returns_long[variable %in% c("EW.RET", "VW.RET")]
```

```{r}
sharpe <- portfolio_returns_long2[, .(SR = mean(Return) / sd(Return),
                              SD = sd(Return), Min = min(Return), Max = max(Return)),
                              by = c("variable", "Portfolio")]
```

```{r}
portfolio_statistics <- portfolio_returns_long2[, t.test(Return, na.rm = T),
                                                by = c("variable", "Portfolio")]
portfolio_statistics[, Count := seq(.N), by = c("variable","Portfolio")][, Count := ifelse(Count == 1, "Lower Bound", "Upper Bound")]

portfolio_statistics <- dcast(portfolio_statistics, ... ~ Count,
                              value.var = "conf.int")
portfolio_statistics <- merge(portfolio_statistics, exp_portfolio_returns_long,
                              by = c("variable", "Portfolio"))
portfolio_statistics <- merge(portfolio_statistics, sharpe, 
                              by = c("variable", "Portfolio"))
round <- colnames(portfolio_statistics[, -c("variable", "Portfolio", "parameter",
                                        "alternative", "method", "data.name")])
portfolio_statistics[, (round) := round(.SD, 4), .SDcols = round]

portfolio_statistics[variable == "VW.RET" & substr(Portfolio, 1, 2) == "NN"]
```

```{r}
oos_r2 <- function(dt, variable) {
  # browser()
  temp <- dt[, .(Date, EXC.USD.RET, MEAN.RET, Company, var = get(variable))]
  temp[, Date := ifelse(month(Date) >= 7, year(Date), year(Date) - 1)]
  temp <- temp[!is.na(var) & Date > "1994", .(method = variable,
  R2OOS = 1 - (sum((EXC.USD.RET - var)^2) / (sum(EXC.USD.RET^2))),
  TRAD.R2OOS = 1 - (sum((EXC.USD.RET - var)^2) /
  (sum((EXC.USD.RET - MEAN.RET)^2)))), by = Date]
  temp <- melt(temp, measure.vars = c("R2OOS", "TRAD.R2OOS"), 
               variable.name = "R2.Method")
  return(temp)
}

scale_oosr2 <- function(dt, exp_ret) {
  # browser()
  dt <- dt[, mean(value), by = c("method", "R2.Method")]
  # dt <- dt[, V1 := dt[method == exp_ret, V1] - V1][method != exp_ret]
  dt <- dt[, V1 := .SD[method == exp_ret, V1] - V1, R2.Method][method != exp_ret]
  dt[, V1 := V1 / sum(V1), by = R2.Method]
  return(dt)
}

load_exp_ret <- function(method, variable) {
  # browser()
  path <- paste("Data/", method, "/", variable , ".Rdata", sep = "")
  load(file = path)
  return(r2)
}
```

```{r}
setorder(data, Date)
data[, MEAN.RET := shift(rollapplyr(EXC.USD.RET, .SD[, .N], mean, partial = T,
                                    na.rm = T), fill = 0), by = Company]
```

```{r}
rf_exp_rets <- rbindlist(lapply(independend_variables, function(x) {
  return(load_exp_ret("RF", x))
}))

rf_exp_rets <- dcast(rf_exp_rets, Date + Company + EXC.USD.RET ~ Variable,
                     value.var = "RF.EXP.RET")
rf_exp_rets <- merge(rf_exp_rets, data[, .(Date, Company, MEAN.RET)],
                     by = c("Date", "Company"))
RF_VI_ts <- rbindlist(lapply(independend_variables, function(x) {
  return(oos_r2(rf_exp_rets, x))
}))
RF_VI_ts <- rbind(RF_VI_ts, oos_r2(data, "RF.EXP.RET"))
RF_r2s_scaled <- scale_oosr2(RF_VI_ts, "RF.EXP.RET")
RF_r2s_scaled[, Rank := rank(.SD$V1), by = R2.Method]
RF_r2_ts <- oos_r2(data, "RF.EXP.RET")

RF_r2 <- data[!is.na(RF.EXP.RET), 
        .(R2OOS = 1 - (sum((EXC.USD.RET - RF.EXP.RET)^2) / (sum(EXC.USD.RET^2))),
         TRAD.R2OOS = 1 - (sum((EXC.USD.RET - RF.EXP.RET)^2) / (sum((EXC.USD.RET - MEAN.RET)^2))))]

RF_r2_2008 <- data[!is.na(RF.EXP.RET) & Date < as.POSIXct("2008-12-31", tz = "UTC"), 
        .(R2OOS = 1 - (sum((EXC.USD.RET - RF.EXP.RET)^2) / (sum(EXC.USD.RET^2))),
         TRAD.R2OOS = 1 - (sum((EXC.USD.RET - RF.EXP.RET)^2) / (sum((EXC.USD.RET - MEAN.RET)^2))))]
```

```{r}
fm_exp_rets <- rbindlist(lapply(independend_variables, function(x) {
  return(load_exp_ret("FM", x))
}))
fm_exp_rets <- dcast(fm_exp_rets, Date + Company + EXC.USD.RET ~ Variable,
                     value.var = "FM.EXP.RET")
fm_exp_rets <- merge(fm_exp_rets, data[, .(Date, Company, MEAN.RET)], 
                     by = c("Date", "Company"))
FM_VI_ts <- rbindlist(lapply(independend_variables, function(x) {
  return(oos_r2(fm_exp_rets, x))
}))
FM_VI_ts <- rbind(FM_VI_ts, oos_r2(data, "FM.EXP.RET"))
FM_r2s_scaled <- scale_oosr2(FM_VI_ts, "FM.EXP.RET")
FM_r2s_scaled[, Rank := rank(.SD$V1), by = R2.Method]
FM_r2_ts <- oos_r2(data, "FM.EXP.RET")
FM_r2 <- data[!is.na(FM.EXP.RET), 
        .(R2OOS = 1 - (sum((EXC.USD.RET - FM.EXP.RET)^2) / (sum(EXC.USD.RET^2))),
          TRAD.R2OOS = 1 - (sum((EXC.USD.RET - FM.EXP.RET)^2) / (sum((EXC.USD.RET - MEAN.RET)^2))))]

FM_r2_2008 <- data[!is.na(FM.EXP.RET) & Date < as.POSIXct("2008-12-31", tz = "UTC"), 
        .(R2OOS = 1 - (sum((EXC.USD.RET - FM.EXP.RET)^2) / (sum(EXC.USD.RET^2))),
          TRAD.R2OOS = 1 - (sum((EXC.USD.RET - FM.EXP.RET)^2) / (sum((EXC.USD.RET - MEAN.RET)^2))))]
```

```{r}
nn_exp_rets <- rbindlist(lapply(independend_variables, function(x) {
  return(load_exp_ret("NN", x))
}))
nn_exp_rets <- dcast(nn_exp_rets, Date + Company + EXC.USD.RET ~ Variable,
                     value.var = "NN.EXP.RET")
nn_exp_rets <- merge(nn_exp_rets, data[, .(Date, Company, MEAN.RET)],
                     by = c("Date", "Company"))
NN_VI_ts <- rbindlist(lapply(independend_variables, function(x) {
  return(oos_r2(nn_exp_rets, x))
}))
NN_VI_ts <- rbind(NN_VI_ts, oos_r2(data, "NN.EXP.RET"))
NN_r2s_scaled <- scale_oosr2(NN_VI_ts, "NN.EXP.RET")
NN_r2s_scaled[, Rank := rank(.SD$V1), by = R2.Method]
NN_r2_ts <- oos_r2(data, "NN.EXP.RET")
NN_r2 <- data[!is.na(NN.EXP.RET), 
        .(R2OOS = 1 - (sum((EXC.USD.RET - NN.EXP.RET)^2) / (sum(EXC.USD.RET^2))),
          TRAD.R2OOS = 1 - (sum((EXC.USD.RET - NN.EXP.RET)^2) /
                              (sum((EXC.USD.RET - MEAN.RET)^2))))]

NN_r2_2008 <- data[!is.na(NN.EXP.RET) & Date < as.POSIXct("2008-12-31", tz = "UTC"), 
        .(R2OOS = 1 - (sum((EXC.USD.RET - NN.EXP.RET)^2) / (sum(EXC.USD.RET^2))),
          TRAD.R2OOS = 1 - (sum((EXC.USD.RET - NN.EXP.RET)^2) / (sum((EXC.USD.RET - MEAN.RET)^2))))]
options(scipen = 999999)
```

```{r}
r2_ts <- merge(FM_r2_ts[, .(Date, R2.Method, FM = value)],
               RF_r2_ts[, .(Date, R2.Method, RF = value)],
               by = c("Date", "R2.Method"))
r2_ts <- merge(r2_ts, NN_r2_ts[, .(Date, R2.Method, NN = value)], 
               by = c("Date", "R2.Method"))
r2_ts <- melt(r2_ts, measure.vars = c("FM", "RF", "NN"), value.name = "R2",
              variable.name = "Method")
r2_ts[, R2.Method := ifelse(R2.Method == "R2OOS", "$R^2_{oos}$",
                            "$R^2_{oos \ Trad.}$")]
r2_ts[, temp := paste(Method, R2.Method, sep = " ")]

tikz(file = "Latex/R_graphs/R2_ts.tex", width = 6, height = 5)
plot5 <- ggplot(r2_ts, aes(Date, R2)) + geom_line() + 
  facet_wrap(~temp, ncol = 2, scales = "free_x") +
  theme(axis.title = element_blank(), text = element_text(size = 9))
print(plot5)
dev.off()
plot5

FM_r2_plot <- ggplot(FM_r2s_scaled[R2.Method == "R2OOS"], aes(y = reorder(method, V1), x = V1)) +
  geom_bar(stat='identity', fill = "#13bfc4") +
  theme(axis.title = element_blank(), text = element_text(size = 9))

trad_FM_r2_plot <- ggplot(FM_r2s_scaled[R2.Method == "TRAD.R2OOS"], aes(y = reorder(method, V1), x = V1)) + geom_bar(stat='identity', fill = "#13bfc4") + theme(axis.title = element_blank(), text = element_text(size = 9))

RF_r2_plot <- ggplot(RF_r2s_scaled[R2.Method == "R2OOS"], aes(y = reorder(method, V1), x = V1)) + geom_bar(stat='identity', fill = "#13bfc4") + theme(axis.title = element_blank(), text = element_text(size = 9))

trad_RF_r2_plot <- ggplot(RF_r2s_scaled[R2.Method == "TRAD.R2OOS"], aes(y = reorder(method, V1), x = V1)) + geom_bar(stat='identity', fill = "#13bfc4") + theme(axis.title = element_blank(), text = element_text(size = 9))

NN_r2_plot <- ggplot(NN_r2s_scaled[R2.Method == "R2OOS"], aes(y = reorder(method, V1), x = V1)) + geom_bar(stat='identity', fill = "#13bfc4") + theme(axis.title = element_blank(), text = element_text(size = 9))

trad_NN_r2_plot <- ggplot(NN_r2s_scaled[R2.Method == "TRAD.R2OOS"], aes(y = reorder(method, V1), x = V1)) + geom_bar(stat='identity', fill = "#13bfc4") + theme(axis.title = element_blank(), text = element_text(size = 9))

grid.arrange(FM_r2_plot, trad_FM_r2_plot, RF_r2_plot, trad_RF_r2_plot, NN_r2_plot,
             trad_NN_r2_plot, ncol = 2)

tikz(file = "Latex/R_graphs/relative_VI.tex", width = 6)
plot6 <- grid.arrange(FM_r2_plot + 
                        facet_wrap(facets = as.factor('FM $R^2_{oos}$')) +
                        ggtitle(NULL) + theme(axis.title = element_blank()),
trad_FM_r2_plot + facet_wrap(facets = as.factor("FM $R^2_{ooos \ Trad.}$")) +
                ggtitle(NULL) + theme(axis.title = element_blank()),
RF_r2_plot + facet_wrap(facets = as.factor("RF $R^2_{oos}$")) + 
                ggtitle(NULL) + theme(axis.title = element_blank()),
trad_RF_r2_plot + facet_wrap(facets = as.factor("RF $R^2_{ooos \ Trad.}$")) +
                ggtitle(NULL) +  theme(axis.title = element_blank()),
NN_r2_plot + facet_wrap(facets = as.factor("NN $R^2_{oos}$")) + 
                ggtitle(NULL) + theme(axis.title = element_blank()),
trad_NN_r2_plot + facet_wrap(facets = as.factor("NN $R^2_{ooos \ Trad.}$")) +
                ggtitle(NULL) + theme(axis.title = element_blank()), nrow = 3)
print(plot6)
dev.off()

temp4 <- merge(RF_r2s_scaled[R2.Method == "R2OOS", .(method, RF = Rank)],
               FM_r2s_scaled[R2.Method == "R2OOS", .(method, FM = Rank)],
               by = "method")
temp4 <- merge(temp4, NN_r2s_scaled[R2.Method == "R2OOS", .(method, NN = Rank)],
               by = "method")
temp5 <- melt(temp4, id.vars = "method")
temp5$variable <- with(temp5, base::factor(variable, levels = c("FM", "RF", "NN")))

tikz(file = "Latex/R_graphs/combined_VI.tex", width = 6, height = 4)
plot7 <- ggplot(temp5, aes(variable, reorder(method, value))) + geom_tile(aes(fill = value), show.legend = F) +
  scale_fill_distiller(palette = "Blues", direction = 1) + scale_x_discrete(expand = c(0, 0)) + scale_y_discrete(expand = c(0, 0)) + theme(axis.title = element_blank())
print(plot7)
dev.off()
plot7
```

```{r}
drawdown <- function(dt) {
  # browser()
  cum_profit <- dt[, .(Date, CUM.RET = cumprod(RET + 1)), by = c("variable", "Method")]
  drawdown <- cum_profit[, .(DRAWDOWN = (CUM.RET - cummax(CUM.RET))/ cummax(CUM.RET)),
                         by = c("variable", "Method")]
  return(drawdown[, .(MDD = round(min(DRAWDOWN), 4)), by = c("variable", "Method")])
}
high_low <- portfolio_returns[variable %in% c("EW.RET", "VW.RET"), 
                              .(Date, variable, RF, FM, NN)]
high_low_long <- melt(high_low, id.vars = c("Date", "variable"),
                      variable.name = "Method", value.name = "RET")
max_drawdown <- drawdown(high_low_long)

min_one_month <- high_low_long[, .(MIN.1MONTH = round(min(RET), 4)), 
                  by = c("variable", "Method")]

sharpe_high_low <- high_low_long[, .(SHARPE = round(mean(RET) / sd(RET), 4)),
                     by = c("variable", "Method")]
```

```{r}
load("Data/factors.Rdata")
factors_wide <- dcast(factors, Date ~ ..., value.var = "USD.RET")
factors_wide <- merge(high_low_long, factors_wide, by = "Date")
FF_stats <- factors_wide[, {reg <- summary(lm(RET ~ RMRF + SMB + HML + RMW + 
                                CMA + MOM, data = .SD, na.action = na.omit))
  list(ALPHA = round(reg$coefficients["(Intercept)", "Estimate"], 4),
  T.STAT = round(reg$coefficients["(Intercept)", "t value"], 4),
  R.SQUARED = round(reg$r.squared, 4))}, by = c("variable", "Method")]
```


```{r}
turnover_long <- copy(data2)
turnover_long <- melt(turnover_long[, -c("pf.size", "year", "EXC.USD.RET",
                           "FM.EXP.RET", "NN.EXP.RET", "RF.EXP.RET")],
                      id.vars = c("Date", "Company", "USD.RET", "L.USD.MV"),
                      value.name = "Portfolio", variable.name = "Method")

turnover_long <- turnover_long[Portfolio %in% c("FM.High", "RF.High", "NN.High",
                                                "FM.Low", "RF.Low", "NN.Low")]
turnover_long[, `:=` (V.WEIGHT = L.USD.MV / sum(L.USD.MV), E.WEIGHT = 1/.N),
              by = c("Date", "Portfolio")]
turnover_long <- melt(turnover_long, measure.vars = c("V.WEIGHT", "E.WEIGHT"),
                      value.name = "WEIGHT", variable.name = "TYPE")
turnover_long[, (c("Method", "Position")) := tstrsplit(Portfolio, ".", fixed = TRUE)]
turnover_long[, USD.RET := ifelse(Position == "High", USD.RET, USD.RET * -1)]

turnover_long[, PORT.RET := weighted.mean(USD.RET, WEIGHT, na.rm = T),
              by = c("Date", "Portfolio", "TYPE")]
turnover_long[, SCALED.RET := (USD.RET + 1)/(PORT.RET + 1)]
turnover_long[, SCALED.WEIGHT := WEIGHT * SCALED.RET]

# Create data.table with all possible date/id combinations
combinations <- turnover_long[, CJ(Date = Date, Company = Company, unique = TRUE)]

turnover_long <- merge(combinations, turnover_long, all.x = T, by = c("Date", "Company"))
turnover_long[is.na(WEIGHT), WEIGHT := 0]
turnover_long[, BOP := shift(SCALED.WEIGHT, 1), by = c("Company", "Portfolio", "TYPE")]
turnover_long[, BOP := ifelse(is.na(BOP), 0, BOP)]
turnover_long[, CHANGE := WEIGHT - BOP]

turnover_long <- turnover_long[!is.na(Portfolio), .(sum(abs(CHANGE))),
                               by = c("Date", "Method", "TYPE")]
turnover_long[, temp := paste("$", Method, "_{", TYPE, "}", "$", sep = " ")]
turnover_long[, Year := ifelse(month(Date) >= 7, year(Date), year(Date) - 1)]

turnover_long_plot <- turnover_long[, mean(V1), by = c("Year", "temp")]

tikz(file = "Latex/R_graphs/turnover.tex", width = 6, height = 5)
plot8 <- ggplot(turnover_long_plot, aes(x = Year, y = V1)) + geom_line() +
  labs(y = "Turnover") + facet_wrap(~temp, scales = "free", ncol = 2) +
  theme(axis.title = element_blank(), text = element_text(size = 9))
print(plot8)
dev.off()

plot8

turnover <- turnover_long[, .(TO = round(mean(V1), 4)), by = c("Method", "TYPE")]
```

```{r}
data3 <- melt(data2[, .(Date, Company, EXC.USD.RET, RF.EXP.RET, FM.EXP.RET, NN.EXP.RET)],
              id.vars = c("Date", "Company", "EXC.USD.RET"), variable.name = "Method",
              value.name = "EXP.RET")
data3[, print(list(.BY, summary(lm(data = .SD, formula = EXC.USD.RET ~ EXP.RET))),
              digits = 5), by = Method]

univariate <- data3[, .(Mean = mean(EXP.RET), SD = sd(EXP.RET)),
                    by = c("Method", "Date")]
univariate <- univariate[, .(Mean = round(mean(Mean), 4),
                             SD = round(mean(SD), 4)), by = Method]
```

```{r}
# TEST!!!
diebold_mariano <- copy(data[, .(Date, Company, EXC.USD.RET,
                              FM.EXP.RET, RF.EXP.RET, NN.EXP.RET, hcol)])
diebold_mariano[, hcol := hcol + 1]
diebold_mariano <- diebold_mariano[, .(FM = mean((EXC.USD.RET - FM.EXP.RET)^2),
                            RF = mean((EXC.USD.RET - RF.EXP.RET)^2),
                            NN = mean((EXC.USD.RET - NN.EXP.RET)^2)), by = hcol]
setorder(diebold_mariano, hcol)


diebold_mariano <- combn(diebold_mariano[!is.na(NN), 2:4], 2, function(x) {
  # browser()
  d <- as.matrix(x[, 1] - x[, 2])
  se <- sqrt(NeweyWest(lm(d ~ 1), lag = 4, prewhite = FALSE)) / sqrt(length(d))
  dm <- mean(d) / se
  return(list(dm, colnames(x), pt(-abs(dm), df = length(d) - 1)))
})
```

# Descriptive statistics

Calculation of descriptive statistics. First I calcualte number of unique companies in whole dataset for each country and for the dataset as whole. Then number of companies in each country in each month is calculated. From this timeseries minimum, mamixum and mean number of companies is calculated again for each country and the pooled dataset. After company counts we repeat the same process for market values. First I calculate time series mean, median and aggregated market values for each country and pooled market for each month. Then the final values are just time series averages of respective variables.
```{r}
# Total number of unique companies
data[year >= 1991, uniqueN(Company), by = Country]
data[year >= 1991, uniqueN(Company)]

# Country level company counts
company_count <- data[year >= 1991, .(number_of_companies = uniqueN(Company)), 
                      by = c("Country", "Date")]
company_count <- company_count[, .(MIN = min(number_of_companies), 
                                   MAX = max(number_of_companies), 
                 MEAN = mean(number_of_companies)), by = Country]

# Company counts for whole Nordic market
company_count_tot <- data[year >= 1991, .(Country = "Nordic",
                           number_of_companies = uniqueN(Company)), by =  Date]
company_count_tot <- company_count_tot[, .(Country = "Nordic", 
                                           MIN = min(number_of_companies), 
                                           MAX = max(number_of_companies),
                                           MEAN = mean(number_of_companies))]
company_count <- rbind(company_count, company_count_tot)

# Country level market values
market_value <- data[, .(MEAN.MV = mean(L.USD.MV, na.rm = T), 
                         MEDIAN.MV = median(L.USD.MV, na.rm = T),
                         SUM.MV = sum(L.USD.MV)), by = c("Country", "Date")]
market_value <- market_value[, .(MEAN.MV = mean(MEAN.MV), 
                                 MEDIAN.MV = mean(MEDIAN.MV),
                                 SUM.MV = mean(SUM.MV)), by = Country]

# Market value statistics for whole nordic market
market_value_tot <-  data[, .(Country = "Nordic", 
                              MEAN.MV = mean(L.USD.MV, na.rm = T), 
                              MEDIAN.MV = median(L.USD.MV, na.rm = T), 
                              SUM.MV = sum(L.USD.MV)), by = c("Date")]
market_value_tot <- market_value_tot[, .(Country = "Nordic", 
                                         MEAN.MV = mean(MEAN.MV), 
                                         MEDIAN.MV = mean(MEDIAN.MV), 
                                         SUM.MV = mean(SUM.MV))]
market_value <- rbind(market_value, market_value_tot)

country_chacteristics <- merge(company_count, market_value, by = "Country")
setorder(country_chacteristics, Country)
```

After country level statistics descriptive statistics are calculated for all dependent and independent variables used in the study. Like with country statistics, we also calculate variable statistics both for separate markets and pooled market. For each variable we calculate mean standard deviation for each month. For both mean and standard deviation the final figure is the time series average of meand and standard deviations of respective variables.
```{r}
var <- c("EXC.USD.RET", independend_variables)
means <- data[, (lapply(.SD, mean, na.rm = T)), .SDcols = var, by = Date]
means <- melt(means, id.vars = "Date", value.name = "MEAN.Nordic")

sds <- data[, (lapply(.SD, sd, na.rm = T)),.SDcols = var, by = Date]
sds <- melt(sds, id.vars = "Date", value.name = "SD.Nordic")

temp <- merge(means, sds, by = c("Date", "variable"))

means <- data[, (lapply(.SD, mean, na.rm = T)), .SDcols = var, 
              by = c("Date", "Country")]
means[, Country := paste("MEAN.", Country, sep = "")]
means <- melt(means, id.vars = c("Date", "Country"), value.name = "Mean")
means <- dcast(means, Date + variable ~ Country, value.var = "Mean")

sds <- data[, (lapply(.SD, sd, na.rm = T)),.SDcols = var, 
            by = c("Date", "Country")]
sds[, Country := paste("SD.", Country, sep = "")]
sds <- melt(sds, id.vars = c("Date", "Country"), value.name = "SD")
sds <- dcast(sds, Date + variable ~ Country, value.var = "SD")

temp2 <- merge(means, sds, by = c("Date", "variable"))
temp3 <- merge(temp, temp2, by = c("Date", "variable"))

sddd <- temp3[, lapply(.SD, mean, na.rm = T), 
              .SDcols = colnames(temp3[, -c("Date", "variable")]), by = variable]

round <- colnames(sddd[, -c("variable")])
sddd[, (round) := round(.SD, 3), .SDcols = round]
```


```{r, fig.height = 24}
variables <- c("Date", "USD.RET", "Company", independend_variables)
test <- data[, ..variables]
test <- melt(test, id.vars = c("Date", "Company"))
test <- test[, .(mean = mean(value)), by = c("Date", "variable")]


tikz(file = "Latex/R_graphs/variable_ts.tex", width = 6, height = 8)
plot9 <- ggplot(test[Date > as.POSIXct("1994-01-01", tz = "UTC")], aes(Date, mean)) +
  geom_line() + facet_wrap(~variable, scales = "free", ncol = 3) +
  theme(axis.title = element_blank(), text = element_text(size = 9))
print(plot9)
dev.off()
```

